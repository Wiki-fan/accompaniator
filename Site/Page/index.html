<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>

<p>Press Init after start</p>
  <div><button id="init" onclick="Init();">INIT</button></div>
  <div>
  <button id="button" onclick="Recording(this);">RECORD</button>
  <button id="stop" onclick="Stop();">STOP</button>
  </div>

  <script>

  var audio_context;
  var recorder;
  var queve = [];
  var isPlaying = false;
  var prev_length = 0;
  var isRecording = false;

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    recorder = new Recorder(input);
  }

  function Send(message=""){
      var ws = new WebSocket('ws://demos.kaazing.com/echo');
      ws.onopen = function(){
          ws.send(message);
      }
      ws.onmessage = function (ev) {
          var s = ev.data;
          console.log(s);
          Push(s);
      }
  }

function Stop() {
    document.getElementById("button").innerText = "STOP";
    recorder && recorder.stop();
    recorder.clear();
    isRecording=false;
    setTimeout(function () {
        document.getElementById("button").innerText = "RECORD";
    }, 1000)
}

  function sleep(milliseconds) {
      var start = new Date().getTime();
      for (var i = 0; i < 1e7; i++) {
          if ((new Date().getTime() - start) > milliseconds){
              break;
          }
      }
  }


  function Push(blob){
      var url = URL.createObjectURL(blob);
      var au = document.createElement('audio');

      au.controls = true;
      au.src = url;
      queve.push(au);
  }


  function RealPlay(){
      if (isRecording) {
          if (queve.length > 0 && !isPlaying){
              isPlaying = true;
              var song = queve.shift();
              song.play();
              setTimeout(function () {
                  isPlaying=false;
              }, 200)
          }
          setTimeout(RealPlay, 200);
      }
  }


  function Recording(button) {
      if (button.innerText == "RECORD") {
          queve = []
          isRecording=true;
          recorder && recorder.record();
          button.innerText = "recording";
          Recording(button);
          setTimeout(RealPlay, 300);
      }
      else if (button.innerText == "recording"){
          SendFrames();
          recorder.clear();
          prev_length = queve.length;
          setTimeout(function () {
              Recording(button)
          }, 200);
      }
  }

  function SendFrames() {
    recorder && recorder.exportWAV(function(blob){
        Send(blob);
    });
  }

  function Init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;

      audio_context = new window.AudioContext;
    } catch (e) {
      alert('No web audio support in this browser!');
    }

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });

  };
  </script>

  <script src="../dist/recorder.js"></script>
</body>
</html>
